<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="file:///android_asset/vditor/dist/index.css" />
    <script src="file:///android_asset/vditor/dist/index.min.js"></script>
    <style>
        :root {
            /* Light theme colors - aligned with Material Design */
            --editor-bg: #FFFFFF;
            --editor-text: #101C22;
            --editor-text-secondary: #555555;
            --editor-border: #E2E8F0;
            --editor-placeholder: #94A3B8;
            
            /* Vditor CSS variable overrides */
            --panel-background-color: #FFFFFF;
            --textarea-background-color: #FFFFFF;
            --textarea-text-color: #101C22;
            --border-color: #E2E8F0;
            --second-color: #94A3B8;
            --toolbar-background-color: #FFFFFF;
            --toolbar-icon-color: #555555;
            --toolbar-icon-hover-color: #101C22;
            --ir-heading-color: #13A4EC;
            --ir-bi-color: #555555;
            --ir-link-color: #13A4EC;
            --ir-title-color: #13A4EC;
            --ir-bracket-color: #13A4EC;
            --ir-paren-color: #555555;
            --blockquote-color: #555555;
            --heading-border-color: #E2E8F0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --editor-bg: #101C22;
                --editor-text: #E2E8F0;
                --editor-text-secondary: #999999;
                --editor-border: #1E2F38;
                --editor-placeholder: #64748B;
                
                --panel-background-color: #101C22;
                --textarea-background-color: #101C22;
                --textarea-text-color: #E2E8F0;
                --border-color: #1E2F38;
                --second-color: #64748B;
                --toolbar-background-color: #1E2F38;
                --toolbar-icon-color: #999999;
                --toolbar-icon-hover-color: #E2E8F0;
                --ir-heading-color: #8CD4F8;
                --ir-bi-color: #999999;
                --ir-link-color: #8CD4F8;
                --ir-title-color: #8CD4F8;
                --ir-bracket-color: #8CD4F8;
                --ir-paren-color: #999999;
                --blockquote-color: #999999;
                --heading-border-color: #1E2F38;
            }
        }

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: var(--editor-bg);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        #vditor {
            border: none !important;
            height: 100vh !important;
            width: 100vw !important;
            background-color: var(--editor-bg) !important;
        }

        .vditor-toolbar {
            display: none !important;
        }

        .vditor-content {
            padding: 16px !important;
            background-color: var(--editor-bg) !important;
        }

        /* IR mode editor area */
        .vditor-ir pre.vditor-reset {
            background-color: var(--editor-bg) !important;
            color: var(--editor-text) !important;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif !important;
            font-size: 16px !important;
            line-height: 1.6 !important;
            padding: 16px !important;
            caret-color: var(--ir-heading-color);
        }

        /* Prevent background change on focus */
        .vditor-ir pre.vditor-reset:focus {
            background-color: var(--editor-bg) !important;
            outline: none !important;
        }

        /* Text content styling */
        .vditor-reset {
            color: var(--editor-text) !important;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif !important;
            font-size: 16px !important;
            line-height: 1.6 !important;
        }

        .vditor-reset p {
            margin-bottom: 12px;
        }

        .vditor-reset h1, .vditor-reset h2, .vditor-reset h3,
        .vditor-reset h4, .vditor-reset h5, .vditor-reset h6 {
            color: var(--editor-text) !important;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 12px;
        }

        .vditor-reset blockquote {
            color: var(--editor-text-secondary) !important;
            border-left-color: var(--editor-border) !important;
        }

        .vditor-reset code:not(.hljs):not(.highlight-chroma) {
            background-color: var(--editor-border) !important;
            color: var(--editor-text) !important;
        }

        /* Placeholder styling */
        .vditor-ir pre.vditor-reset:empty::before {
            color: var(--editor-placeholder) !important;
        }

        /* Remove any unwanted visual effects */
        .vditor, .vditor * {
            box-shadow: none !important;
        }

        .vditor-ir__node--expand .vditor-ir__marker {
            color: var(--editor-text-secondary) !important;
        }

        /* Enhanced image styling */
        .vditor-reset img {
            max-width: 100% !important;
            height: auto !important;
            border-radius: 12px !important;
            margin: 16px 0 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04) !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
            display: block !important;
        }

        .vditor-reset img:hover {
            transform: scale(1.01) !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.06) !important;
        }

        /* Image container styling for IR mode */
        .vditor-ir .vditor-ir__node[data-type="img"] {
            display: block !important;
            text-align: center !important;
            margin: 12px 0 !important;
        }

        /* Image alt text styling */
        .vditor-ir .vditor-ir__node[data-type="img"] .vditor-ir__marker--info {
            display: block !important;
            text-align: center !important;
            font-size: 13px !important;
            color: var(--editor-text-secondary) !important;
            font-style: italic !important;
            margin-top: 8px !important;
            opacity: 0.8 !important;
        }

        @media (prefers-color-scheme: dark) {
            .vditor-reset img {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.24), 0 2px 4px rgba(0, 0, 0, 0.16) !important;
            }

            .vditor-reset img:hover {
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.32), 0 4px 8px rgba(0, 0, 0, 0.20) !important;
            }
        }
    </style>
</head>
<body>
    <div id="vditor"></div>
    <script>
        let vditor;
        console.log("JS: Script block execution started");

        window.onerror = function(message, source, lineno, colno, error) {
            console.error("JS Global Error: " + message + " at " + source + ":" + lineno);
            return false;
        };
        
        function initVditor(initialContent) {
            console.log("JS: initVditor called with content length: " + (initialContent ? initialContent.length : 0));
            if (typeof Vditor === 'undefined') {
                console.error("JS: Vditor is NOT defined! Check script loading.");
                return;
            }
            try {
                vditor = new Vditor('vditor', {
                    height: '100%',
                    mode: 'ir',
                    value: initialContent || '',
                    placeholder: '开始输入...',
                    cache: {
                        enable: false
                    },
                    cdn: 'file:///android_asset/vditor',
                    lang: 'zh_CN',
                    input(value) {
                        if (window.Android) {
                            window.Android.onContentChange(value);
                        }
                    },
                    after() {
                        const contentHtml = document.getElementById('vditor').innerHTML;
                        console.log("JS: Vditor initialized successfully. Inner HTML length: " + contentHtml.length);
                        if (window.Android) {
                            window.Android.onEditorReady();
                        }
                    }
                });
            } catch (e) {
                console.error("JS: Vditor init failed: " + e.message);
                console.error(e.stack);
            }
        }

        function setContent(content) {
            if (vditor) {
                vditor.setValue(content);
            }
        }

        function getContent() {
            return vditor ? vditor.getValue() : '';
        }

        // Format commands called from Android
        function formatBold() {
            if (!vditor) return;
            const selection = vditor.getSelection();
            if (selection) {
                vditor.deleteValue();
                vditor.insertValue('**' + selection + '**', true);
            } else {
                vditor.insertValue('**粗体**', true);
            }
        }

        function formatItalic() {
            if (!vditor) return;
            const selection = vditor.getSelection();
            if (selection) {
                vditor.deleteValue();
                vditor.insertValue('*' + selection + '*', true);
            } else {
                vditor.insertValue('*斜体*', true);
            }
        }

        function formatList() {
            if (!vditor) return;
            vditor.insertValue('\n- ', true);
        }

        function formatQuote() {
            if (!vditor) return;
            vditor.insertValue('\n> ', true);
        }

        function formatCode() {
            if (!vditor) return;
            const selection = vditor.getSelection();
            if (selection) {
                vditor.deleteValue();
                vditor.insertValue('`' + selection + '`', true);
            } else {
                vditor.insertValue('`代码`', true);
            }
        }

        function insertImage(url, description) {
            if (!vditor) return;
            const desc = description || '图片';
            const imgUrl = url || '';
            vditor.insertValue('![' + desc + '](' + imgUrl + ')', true);
        }

        function insertLink(url, text) {
            if (!vditor) return;
            const selection = vditor.getSelection();
            if (selection && !text) {
                vditor.deleteValue();
                vditor.insertValue('[' + selection + '](' + (url || '') + ')', true);
            } else {
                const linkText = text || '链接';
                vditor.insertValue('[' + linkText + '](' + (url || '') + ')', true);
            }
        }

        // Notify Android that the page is fully loaded and ready for init
        window.onload = function() {
            console.log("JS: window.onload");
            if (window.Android && window.Android.onPageLoaded) {
                window.Android.onPageLoaded();
            }
        };
    </script>
</body>
</html>