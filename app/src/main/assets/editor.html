<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="file:///android_asset/vditor/dist/index.css" />
    <script src="file:///android_asset/vditor/dist/index.min.js"></script>
    <style>
        :root {
            /* Light theme colors */
            --editor-bg: #FFFFFF;
            --editor-text: #101C22;
            --editor-text-secondary: #555555;
            --editor-border: #E2E8F0;
            --editor-placeholder: #94A3B8;
            
            /* Vditor CSS variable overrides */
            --panel-background-color: #FFFFFF;
            --textarea-background-color: #FFFFFF;
            --textarea-text-color: #101C22;
            --border-color: #E2E8F0;
            --second-color: #94A3B8;
            --toolbar-background-color: #FFFFFF;
            --toolbar-icon-color: #555555;
            --toolbar-icon-hover-color: #101C22;
            --ir-heading-color: #13A4EC;
            --ir-bi-color: #555555;
            --ir-link-color: #13A4EC;
            --ir-title-color: #13A4EC;
            --ir-bracket-color: #13A4EC;
            --ir-paren-color: #555555;
            --blockquote-color: #555555;
            --heading-border-color: #E2E8F0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --editor-bg: #101C22;
                --editor-text: #E2E8F0;
                --editor-text-secondary: #999999;
                --editor-border: #1E2F38;
                --editor-placeholder: #64748B;
                
                --panel-background-color: #101C22;
                --textarea-background-color: #101C22;
                --textarea-text-color: #E2E8F0;
                --border-color: #1E2F38;
                --second-color: #64748B;
                --toolbar-background-color: #1E2F38;
                --toolbar-icon-color: #999999;
                --toolbar-icon-hover-color: #E2E8F0;
                --ir-heading-color: #8CD4F8;
                --ir-bi-color: #999999;
                --ir-link-color: #8CD4F8;
                --ir-title-color: #8CD4F8;
                --ir-bracket-color: #8CD4F8;
                --ir-paren-color: #999999;
                --blockquote-color: #999999;
                --heading-border-color: #1E2F38;
            }
        }

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: var(--editor-bg);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        #vditor {
            border: none !important;
            height: 100vh !important;
            width: 100vw !important;
            background-color: var(--editor-bg) !important;
        }

        .vditor-toolbar {
            display: none !important;
        }

        .vditor-content {
            padding: 16px !important;
            background-color: var(--editor-bg) !important;
        }

        /* IR mode editor area */
        .vditor-ir pre.vditor-reset {
            background-color: var(--editor-bg) !important;
            color: var(--editor-text) !important;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif !important;
            font-size: 16px !important;
            line-height: 1.6 !important;
            padding: 16px !important;
            caret-color: var(--ir-heading-color);
        }

        /* Prevent background change on focus */
        .vditor-ir pre.vditor-reset:focus {
            background-color: var(--editor-bg) !important;
            outline: none !important;
        }

        /* Text content styling */
        .vditor-reset {
            color: var(--editor-text) !important;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif !important;
            font-size: 16px !important;
            line-height: 1.6 !important;
        }

        .vditor-reset p {
            margin-bottom: 12px;
        }

        .vditor-reset h1, .vditor-reset h2, .vditor-reset h3,
        .vditor-reset h4, .vditor-reset h5, .vditor-reset h6 {
            color: var(--editor-text) !important;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 12px;
        }

        .vditor-reset blockquote {
            color: var(--editor-text-secondary) !important;
            border-left-color: var(--editor-border) !important;
        }

        .vditor-reset code:not(.hljs):not(.highlight-chroma) {
            background-color: var(--editor-border) !important;
            color: var(--editor-text) !important;
        }

        /* Placeholder styling */
        .vditor-ir pre.vditor-reset:empty::before {
            color: var(--editor-placeholder) !important;
        }

        /* Remove any unwanted visual effects */
        .vditor, .vditor * {
            box-shadow: none !important;
        }

        .vditor-ir__node--expand .vditor-ir__marker {
            color: var(--editor-text-secondary) !important;
        }

        /* Enhanced image styling */
        .vditor-reset img {
            max-width: 100% !important;
            height: auto !important;
            border-radius: 12px !important;
            margin: 16px 0 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04) !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
            display: block !important;
        }

        .vditor-reset img:hover {
            transform: scale(1.01) !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.06) !important;
        }

        /* Image container styling for IR mode */
        .vditor-ir .vditor-ir__node[data-type="img"] {
            display: block !important;
            text-align: center !important;
            margin: 12px 0 !important;
        }

        /* Image alt text styling */
        .vditor-ir .vditor-ir__node[data-type="img"] .vditor-ir__marker--info {
            display: block !important;
            text-align: center !important;
            font-size: 13px !important;
            color: var(--editor-text-secondary) !important;
            font-style: italic !important;
            margin-top: 8px !important;
            opacity: 0.8 !important;
        }

        @media (prefers-color-scheme: dark) {
            .vditor-reset img {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.24), 0 2px 4px rgba(0, 0, 0, 0.16) !important;
            }

            .vditor-reset img:hover {
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.32), 0 4px 8px rgba(0, 0, 0, 0.20) !important;
            }
        }
    </style>
</head>
<body>
    <div id="vditor"></div>
    <script>
        let vditor;
        let inputDebounceTimer = null;
        let lastSentContent = '';
        const DEBOUNCE_DELAY = 150;

        window.onerror = function(message, source, lineno, colno, error) {
            console.error("JS Error: " + message);
            return false;
        };

        function notifyContentChange(value) {
            if (value === lastSentContent) return;
            
            if (inputDebounceTimer) {
                clearTimeout(inputDebounceTimer);
            }
            
            inputDebounceTimer = setTimeout(function() {
                if (window.Android && value !== lastSentContent) {
                    lastSentContent = value;
                    window.Android.onContentChange(value);
                }
            }, DEBOUNCE_DELAY);
        }

        // Flush pending content immediately, cancel debounce
        function flushContent() {
            if (inputDebounceTimer) {
                clearTimeout(inputDebounceTimer);
                inputDebounceTimer = null;
            }
            var value = vditor ? vditor.getValue() : '';
            if (window.Android && value !== lastSentContent) {
                lastSentContent = value;
                window.Android.onContentChange(value);
            }
        }

        function initVditor(initialContent) {
            if (typeof Vditor === 'undefined') return;
            
            // If vditor exists, just set content
            if (vditor) {
                lastSentContent = initialContent || '';
                vditor.setValue(initialContent || '');
                if (window.Android) {
                    window.Android.onEditorReady();
                }
                return;
            }
            
            lastSentContent = initialContent || '';
            
            vditor = new Vditor('vditor', {
                height: '100%',
                mode: 'ir',
                value: initialContent || '',
                placeholder: '开始输入...',
                cache: { enable: false },
                cdn: 'file:///android_asset/vditor',
                lang: 'zh_CN',
                toolbarConfig: { hide: true },
                preview: { hljs: { enable: false } },
                input: notifyContentChange,
                after() {
                    if (window.Android) {
                        window.Android.onEditorReady();
                    }
                }
            });
        }

        function setContent(content) {
            if (vditor) {
                lastSentContent = content;
                vditor.setValue(content);
            }
        }

        function getContent() {
            return vditor ? vditor.getValue() : '';
        }

        function formatBold() {
            if (!vditor) return;
            const sel = vditor.getSelection();
            if (sel) {
                vditor.deleteValue();
                vditor.insertValue('**' + sel + '**', true);
            } else {
                vditor.insertValue('**粗体**', true);
            }
        }

        function formatItalic() {
            if (!vditor) return;
            const sel = vditor.getSelection();
            if (sel) {
                vditor.deleteValue();
                vditor.insertValue('*' + sel + '*', true);
            } else {
                vditor.insertValue('*斜体*', true);
            }
        }

        function formatList() {
            if (!vditor) return;
            vditor.insertValue('\n- ', true);
        }

        function formatQuote() {
            if (!vditor) return;
            vditor.insertValue('\n> ', true);
        }

        function formatCode() {
            if (!vditor) return;
            const sel = vditor.getSelection();
            if (sel) {
                vditor.deleteValue();
                vditor.insertValue('`' + sel + '`', true);
            } else {
                vditor.insertValue('`代码`', true);
            }
        }

        function insertImage(url, description) {
            if (!vditor) return;
            vditor.insertValue('![' + (description || '图片') + '](' + (url || '') + ')', true);
        }

        function insertLink(url, text) {
            if (!vditor) return;
            const sel = vditor.getSelection();
            if (sel && !text) {
                vditor.deleteValue();
                vditor.insertValue('[' + sel + '](' + (url || '') + ')', true);
            } else {
                vditor.insertValue('[' + (text || '链接') + '](' + (url || '') + ')', true);
            }
        }

        window.onload = function() {
            if (window.Android && window.Android.onPageLoaded) {
                window.Android.onPageLoaded();
            }
        };
    </script>
</body>
</html>